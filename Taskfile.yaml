version: '3'  

tasks:
  default:
    silent: true
    cmds:
      - task --list
        
  build:
    desc: "Build the docker compose environment"
    cmds:
      - docker compose build

  run:local:
    desc: "Run local docker compose in a simple development environment"
    cmds:
      - docker compose up

  run:local:sim:
    desc: "Run local docker compose environment mirroring production setup"
    cmds:
      - docker compose -f docker-compose.yaml -f infra/local/docker-compose.yaml up

  clean:local:
    desc: "Stop and remove local docker compose environment"
    cmds:
      - docker compose down --volumes --remove-orphans

  test:integration:
    desc: "Run tests against the server"
    dir: backend/src/harmony/tests
    env:
      API_ENDPOINT: http://localhost:8000
    cmds:
      - pytest -m integration

  test:stress:
    desc: "Run stress tests against the server"
    dir: backend/src/harmony/tests
    env:
      API_ENDPOINT: http://localhost:8000
    cmds:
      - pytest -m stress -s -v

  schema:sync:
    desc: "Sync OpenAPI schema from backend to frontend"
    cmds:
      - task schema:extract
      - task schema:generate
  
  schema:extract:
    desc: "Extract OpenAPI schema from FastAPI and save to frontend"
    cmds:
      - python backend/specs/extract_openapi.py > frontend/openapi.json

  schema:generate:
    desc: "Generate API client from OpenAPI schema using Orval"
    dir: frontend
    cmds:
      - npx orval

  test:generate:
    desc: "Run the data generation script to populate the database with test data"
    dir: backend/src/harmony/tests/tools
    cmds:
      - pytest generate.py -s

  test:generate:clean:
    desc: "Clean up generated test data from the database"
    dir: backend/src/harmony/tests/tools
    cmds:
      - rm -f generated_data.json